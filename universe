#!/bin/bash
# Variable and constant declaration
curDir=$(dirname "$(realpath "$0")")
env=$(uname)
ext=$([ "$env" = "Darwin" ] && echo "__macOS" || echo "__linux")
extOmit=$([ "$env" = "Darwin" ] && echo "__linux" || echo "__macOS")
localPath="local"
serverClientPath="server/client"
serverHostPath="server/host"
## Color
colorOff='\033[0m'
boldGreen='\033[1;32m'
boldRed='\033[1;31m'
boldWhite='\033[1;37m'
boldYellow='\033[1;33m'


# Function declaration
checkOptionsExist() {
	if [ $# -eq 0 ]
	then
		displayHelp
		exit 0
	fi
}

checkSecondaryOptions() {
	mode=$1
	option=$2
	ext=$3
	flag=false
	for arg in ${@:4}
	do
		fail=false
		if [ $arg != '-s' ] && [ $arg != '-S' ]
		then
			if [ $option = "list" ]
			then
				if [ $arg != "install" ] && [ $arg != "link" ] && [ $arg != "command" ] && [ $arg != "update" ]
				then
					fail=true
				fi
			else
				if [ $(cat "$curDir/build/$mode/Makefile" | grep -w "$option-$arg:" | wc -l) = 0 ] && [ $(cat "$curDir/build/$mode/Makefile" | grep -w "$option-$arg$ext:" | wc -l) = 0 ]
				then
					fail=true
				fi
			fi
			if [ $fail = true ]
			then
				if [ $flag = false ]
				then
					echo
					flag=true
				fi
				echo -e "${boldRed}Error:${colorOff} ${boldWhite}'$arg'${colorOff} not recognized by ${boldWhite}'$option'${colorOff}."
			fi
		fi
	done
	if [ $flag = true ]
	then
		exit 3
	fi
}

checkSecondaryOptionsExist() {
	option=$1
	if [ $# -eq 2 ] && [ $option != "list" ] && [ $option != "install" ] && [ $option != "link" ] && [ $option != "update" ]
	then
		echo
		echo -e "${boldRed}Error:${colorOff} No option is given to ${boldWhite}'$option'${colorOff}."
		exit 3
	fi
}

checkValidMainOption() {
	option=$1
	mainOptions=("install" "link" "command" "update" "list" "--help" "-h" "--prefix" "-p")
	flag=false
	for mainOption in ${mainOptions[@]}
	do
		if [ $option = $mainOption ]
		then
			flag=true
			break
		fi
	done
	if [ $flag = false ]
	then
		echo -e "${boldRed}Error:${colorOff} ${boldWhite}'$option'${colorOff} not recognized by ${boldWhite}Universe${colorOff}."
		exit 3
	fi
}

displayHelp() {
	# Display Help
	echo "Universe: your world always with you."
	echo
	echo "Syntax: universe [options]"
	echo
	echo "  Options:"
	echo "    install		   Installs a given software handled by Universe and related"
	echo "			   to your OS. If nothing is given, it installs all software"
	echo "			   related to your OS."
	echo "    update		   Updates a software installed with 'install'. If nothing is"
	echo "			   given, it updates all software handled by Universe and"
	echo "			   related to your OS."
	echo "    link		   Setups a configuration file handled by Universe and"
	echo "             		   related to your OS for a given software. If nothing is"
	echo "			   given, it setups all configuration files related to your"
	echo "			   OS."
	echo "    command         	   Applies a command for a specific software, according to"
	echo "             		   your OS."
	echo "    list		   Shows the available options for 'install', 'update', 'link'"
	echo "			   and 'command' related to your OS. If nothing is given, it" 
	echo "			   shows all the options for 'install', 'update', 'link' and"
	echo "			   'command' related to your OS."
	echo "    -p, --prefix		   Prints the path of Universe folder."
	echo "    -h, --help		   Prints this help."
}

displayMode() {
	mode=$1
	if [ $mode = $localPath ]
	then
		echo -e "${boldWhite}Mode:${colorOff} ${boldGreen}Client${colorOff}"
	else
		if [ $mode = $serverClientPath ]
		then
			echo -e "${boldWhite}Mode:${colorOff} ${boldYellow}Server (Client)${colorOff}"
		else
			echo -e "${boldWhite}Mode:${colorOff} ${boldRed}Server (Host)${colorOff}"
		fi
		if [ "$env" = "Darwin" ]
		then
			echo -e "${boldYellow}Warning:${colorOff} macOS doesn't have a server version."
		fi
	fi
}

displayPrefix() {
	echo $curDir
}

execOptions() {
	mode=$1
	option=$2
	ext=$3
	extOmit=$4
	for arg in ${@:5}
	do
		if [ $arg != '-s' ] && [ $arg != '-S' ]
		then
			if [ $option = "list" ]
			then
				echo
				echo -e "${boldWhite}List for '$arg':${colorOff}"
				list=$(grep "^$arg-[a-z]*" "$curDir/build/$mode/Makefile" | grep  -v $extOmit | wc -l)
				if [ $list -eq 0 ]
				then
					echo "   No options available."
				else
					grep "^$arg-[a-z]*" "$curDir/build/$mode/Makefile" | sed 's/://' | sed 's/'$ext'//' | sed 's/'$arg'-//' | grep  -v $extOmit | sed -e 's/^/   /'
				fi
			else
				echo
				echo -e "${boldWhite}Processing '$option $arg':${colorOff}" 
				if [ $(cat "$curDir/build/$mode/Makefile" | grep -w "$option-$arg:" | wc -l) != 0 ]
				then
					make -C $curDir/build/$mode $option-$arg --no-print-directory
				else
					make -C $curDir/build/$mode $option-$arg$ext --no-print-directory
				fi
			fi
		
		fi
	done
}

execIfHelpAsMainOption() {
	if [ $1 = "--help" ] || [ $1 = "-h" ]
	then
		displayHelp
		exit 0
	fi
}

execIfPrefixAsMainOption() {
	if [ $1 = "--prefix" ] || [ $1 = "-p" ]
	then
		displayPrefix
		exit 0
	fi
}

execIfSupport() {
	execIfHelpAsMainOption "$1"
	execIfPrefixAsMainOption "$1"
}

execIfShorcut() {
	mode=$1
	option=$2
	ext=$3
	if [ $# -eq 3 ] || { [ $# -eq 4 ] && [ $4 = '-s' ] ;} || { [ $# -eq 4 ] && [ $4 = '-S' ] ;}
	then
		if [ $option = "install" ] || [ $option = "link" ] || [ $option = "update" ]
		then
			execShortcutOS "$mode" "$option" "$ext"
		elif [ $option = "list" ]
		then
			execShortcutList "$mode"
		fi
	fi
}

execShortcutOS() {
	mode=$1
	option=$2
	ext=$3
	displayMode "$mode"
	echo
	echo -e "${boldWhite}Processing all '$option' related to your OS:${colorOff}"
	make -C $curDir/build/$mode $option$ext --no-print-directory
	exit $?
}

execShortcutList() {
	mode=$1
	if [ $mode = $serverClientPath ]
	then
		$curDir/universe list "-s" "install" "update" "link" "command"
	elif [ $mode = $serverHostPath ]
	then
		$curDir/universe list "-S" "install" "update" "link" "command"
	else
		$curDir/universe list "install" "update" "link" "command"
	fi
	exit $?
}

getMode() {
	i=1
	mode=$localPath
	for arg in "$@"
	do
		if [ $arg = "-s" ]
		then
			mode=$serverClientPath
		elif [ $arg = "-S" ]
		then
			mode=$serverHostPath
		fi
	done
	echo "$mode"
}


# Executable
## Check options exist
checkOptionsExist "$@"
main=$1
## Check main option valid
checkValidMainOption "$main"
## Get the chosen mode (default -> local, "-s" -> server/client and "-S" -> server/host)
mode=$(getMode "$@")
## Proceed if it's a support option as the main option
execIfSupport "$main"
## Proceed if it's a shortcut
execIfShorcut "$mode" "$main" "$ext" "${@:2}"
## Check if the main option has secondary options
checkSecondaryOptionsExist "$main" "${@:2}"
## Display the mode used
displayMode "$mode"
## Check the secondary options
checkSecondaryOptions "$mode" "$main" "$ext" "${@:2}"
## Proceed the main option with the secondary options
execOptions "$mode" "$main" "$ext" "$extOmit" "${@:2}"